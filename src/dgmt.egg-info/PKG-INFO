Metadata-Version: 2.4
Name: dgmt
Version: 2.0.0
Summary: Dylan's General Management Tool - Hub-and-spoke sync orchestrator
Author: Dylan
License: MIT
Project-URL: Homepage, https://github.com/dylan/dgmt
Keywords: sync,syncthing,rclone,sftp,backup
Classifier: Development Status :: 4 - Beta
Classifier: Environment :: Console
Classifier: Intended Audience :: Developers
Classifier: Intended Audience :: End Users/Desktop
Classifier: License :: OSI Approved :: MIT License
Classifier: Operating System :: OS Independent
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Classifier: Programming Language :: Python :: 3.12
Classifier: Topic :: System :: Archiving :: Backup
Classifier: Topic :: System :: Filesystems
Requires-Python: >=3.10
Description-Content-Type: text/markdown
Requires-Dist: watchdog>=3.0.0
Requires-Dist: requests>=2.28.0
Requires-Dist: paramiko>=3.0.0
Provides-Extra: dev
Requires-Dist: pytest>=7.0.0; extra == "dev"
Requires-Dist: pytest-cov>=4.0.0; extra == "dev"
Requires-Dist: ruff>=0.1.0; extra == "dev"
Requires-Dist: mypy>=1.0.0; extra == "dev"

# dgmt - Dylan's General Management Tool

Hub-and-spoke sync orchestrator supporting multiple backends (Syncthing, SFTP, rclone).

## Architecture

```mermaid
graph TB
    Cloud[(Cloud<br/>rclone)]
    Hub[HUB<br/>laptop]
    Spoke1[Spoke<br/>PC]
    Spoke2[Spoke<br/>server]
    Spoke3[Spoke<br/>NAS]

    Cloud -.->|optional| Hub
    Hub <-->|Syncthing| Spoke1
    Hub <-->|SFTP| Spoke2
    Hub <-->|Syncthing| Spoke3
```

- **Hub**: Machine running dgmt in full mode
- **Spokes**: Remote machines syncing with the hub via configured backend
- **Backends**: Syncthing (P2P), SFTP/rsync (direct), rclone (cloud)

### Daemon Flow

```mermaid
graph TB
    subgraph startup["On Startup"]
        PULL[Pull from remote]
        BISYNC[Bidirectional sync]
        PULL --> BISYNC
    end

    subgraph running["While Running"]
        W[watchdog<br/>monitors files]
        D[debouncer<br/>waits for quiet period]
        SYNC[sync to backends]
        W --> D --> SYNC
    end

    subgraph background["Background"]
        H[Syncthing health monitor]
        C[Config file watcher<br/>hot reload]
    end

    startup --> running
```

## Installation

```bash
pip install -e .
dgmt init
```

## CLI

```bash
# Service
dgmt install          # Install as system service
dgmt uninstall        # Remove service
dgmt start            # Start service
dgmt stop             # Stop service
dgmt status           # Show status
dgmt run              # Run in foreground

# Sync
dgmt sync             # Manual sync
dgmt sync --pull      # Pull only
dgmt sync --push      # Push only

# Remote machines
dgmt remote add <host> [--backend sftp|syncthing] [--folder ~/path]
dgmt remote remove <host>
dgmt remote list
dgmt remote status <host>
dgmt remote ssh <host>

# Configuration
dgmt config           # Show config
dgmt config edit      # Open in $EDITOR
dgmt config set <key> <value>
dgmt config add-watch <path>
dgmt config backend <name>
```

## Configuration

`~/.dgmt/config.json`:

```json
{
  "hub": {
    "watch_paths": ["~/Obsidian"],
    "debounce_seconds": 30,
    "max_wait_seconds": 300,
    "health_check_interval": 60,
    "pull_on_startup": true
  },
  "defaults": {
    "backend": "syncthing"
  },
  "spokes": {
    "webserver": {
      "backend": "sftp",
      "remote_path": "/home/user/notes",
      "enabled": true
    }
  },
  "backends": {
    "rclone": {
      "remote": "gdrive",
      "dest": "Backup",
      "enabled": false
    },
    "syncthing": {
      "api": "http://localhost:8384",
      "stop_on_exit": true,
      "restart_on_failure": true
    }
  },
  "logging": {
    "file": "~/.dgmt/dgmt.log",
    "level": "INFO"
  }
}
```

| Key | Description |
|-----|-------------|
| `hub.watch_paths` | Folders to monitor for changes |
| `hub.debounce_seconds` | Quiet period before triggering sync |
| `hub.max_wait_seconds` | Force sync after this duration |
| `hub.health_check_interval` | Syncthing health check frequency |
| `defaults.backend` | Default backend for new spokes |
| `spokes.<name>` | Remote machine configurations |
| `backends.rclone.enabled` | Enable cloud backup via rclone |
| `backends.syncthing.stop_on_exit` | Kill Syncthing when dgmt stops |
| `logging.level` | DEBUG, INFO, WARNING, ERROR |

**Hot reload**: The daemon watches `config.json` and applies changes automatically. No restart required.

## Fluent Configuration API

Configure dgmt programmatically in Python:

```python
from dgmt import Config

config = (
    Config()
    .watch("~/Obsidian", "~/Documents/notes")
    .with_backend("syncthing")
    .debounce(seconds=30)
    .health_check(interval=60)
    .stop_syncthing_on_exit(True)
    .add_spoke("webserver", backend="sftp", remote_path="/home/user/notes")
    .save()
)
```

This produces the equivalent JSON:

```json
{
  "hub": {
    "watch_paths": ["~/Obsidian", "~/Documents/notes"],
    "debounce_seconds": 30,
    "health_check_interval": 60
  },
  "defaults": { "backend": "syncthing" },
  "spokes": {
    "webserver": {
      "backend": "sftp",
      "remote_path": "/home/user/notes",
      "enabled": true
    }
  },
  "backends": {
    "syncthing": { "stop_on_exit": true }
  }
}
```

## Prerequisites

- **Python 3.10+**
- **Syncthing** (optional, for P2P sync)
- **rclone** (optional, for cloud backup)
- **rsync** (optional, for SFTP backend)

## Logs

Logs are written to `~/.dgmt/dgmt.log`:

```
[2025-01-31 09:15:32] INFO: dgmt starting up
[2025-01-31 09:15:32] INFO: Watching: ['C:\\Users\\dylan\\Obsidian']
[2025-01-31 09:15:32] INFO: Running initial sync...
[2025-01-31 09:15:45] INFO: Sync completed: C:\Users\dylan\Obsidian
[2025-01-31 09:23:17] INFO: Quiet period reached, triggering sync
```

Set `logging.level` to `DEBUG` for verbose output.

## Troubleshooting

**"rclone not found"**
- Ensure rclone is in your PATH: `scoop install rclone` (Windows) or `apt install rclone` (Linux)

**"Syncthing not responding" keeps appearing**
- Check if Syncthing is running: `http://localhost:8384`
- Verify API key in config if you've changed Syncthing's default settings
- Set `restart_on_failure: false` to disable auto-restart

**First sync fails with bisync error**
- Normal on first run - dgmt uses `--resync` automatically
- If it persists: `rclone bisync ~/Obsidian remote:Backup --resync`

**Changes not syncing**
- Check `~/.dgmt/dgmt.log` for errors
- Verify `hub.watch_paths` in config
- Set `logging.level: "DEBUG"` for more detail

**Service won't start**
- Windows: Check Task Scheduler for "dgmt" task
- Linux: `journalctl --user -u dgmt` for systemd logs
